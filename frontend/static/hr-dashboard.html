<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>HR Assistant</title>
  <script src="https://unpkg.com/htmx.org@1.9.10"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen p-8">

  <h1 class="text-4xl font-bold mb-8 text-gray-800">üìã –°–ø–∏—Å–æ–∫ –≤–∞–∫–∞–Ω—Å–∏–π</h1>

  <div class="mb-6">
    <button
      hx-get="http://localhost:8000/vacancies"
      hx-target="#vacancy-list"
      hx-swap="innerHTML"
      class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white text-lg rounded-xl shadow transition"
    >
      üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫
    </button>
  </div>

  <div id="vacancy-list" class="overflow-hidden rounded-xl shadow-lg border bg-white">
    <div class="p-6 text-gray-500">–ù–∞–∂–º–∏—Ç–µ "–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫", —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤–∞–∫–∞–Ω—Å–∏–∏.</div>
  </div>

  <script>
    document.body.addEventListener("htmx:afterOnLoad", function(evt) {
      if (evt.detail.target.id === "vacancy-list") {
        try {
          const data = JSON.parse(evt.detail.xhr.responseText);
          console.log("–î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã:", data);

          if (Array.isArray(data) && data.length > 0) {
            // –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
            const tableHTML = createVacanciesTable(data);
            evt.detail.target.innerHTML = tableHTML;
          } else {
            evt.detail.target.innerHTML = '<div class="p-6 text-gray-500">–ù–µ—Ç –≤–∞–∫–∞–Ω—Å–∏–π –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>';
          }
        } catch (e) {
          console.error("–û—à–∏–±–∫–∞:", e);
          evt.detail.target.innerHTML = `<div class="p-6 text-red-600">–û—à–∏–±–∫–∞: ${e.message}</div>`;
        }
      }
    });

    function createVacanciesTable(data) {
      // –í—ã–±–∏—Ä–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
      const columns = [
        { key: 'id', title: 'ID', width: 'w-16' },
        { key: 'vacancy_title', title: '–î–æ–ª–∂–Ω–æ—Å—Ç—å', width: 'w-48' },
        { key: 'salary', title: '–ó–∞—Ä–ø–ª–∞—Ç–∞', width: 'w-32', format: formatSalary },
        { key: 'status', title: '–°—Ç–∞—Ç—É—Å', width: 'w-40', format: formatStatus },
        { key: 'created_at', title: '–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è', width: 'w-48', format: formatDate },
        { key: 'questions', title: '–í–æ–ø—Ä–æ—Å—ã', width: 'w-24', format: formatQuestions }
      ];

      return `
        <div class="overflow-x-auto">
          <table class="w-full border-collapse">
            <thead>
              <tr class="bg-gray-100 text-left text-gray-700">
                ${columns.map(col =>
                  `<th class="p-4 border-b font-semibold ${col.width}">${col.title}</th>`
                ).join('')}
              </tr>
            </thead>
            <tbody>
              ${data.map(vacancy => `
                <tr class="border-b hover:bg-gray-50 transition" data-vacancy-id="${vacancy.id}">
                  ${columns.map(col => {
                    const value = vacancy[col.key];
                    const formattedValue = col.format ? col.format(value) : formatDefault(value);
                    return `<td class="p-4 align-top">${formattedValue}</td>`;
                  }).join('')}
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
        <div class="p-4 bg-gray-50 text-sm text-gray-600">
          –ù–∞–π–¥–µ–Ω–æ –≤–∞–∫–∞–Ω—Å–∏–π: ${data.length}
        </div>
      `;
    }

    // –§—É–Ω–∫—Ü–∏–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    function formatDefault(value) {
      if (value === null || value === undefined || value === '') return '‚Äî';
      if (typeof value === 'string' && value.trim() === '') return '‚Äî';
      return value;
    }

    function formatSalary(value) {
      if (!value || value === 0) return '‚Äî';
      return `${value.toLocaleString('ru-RU')} ‚ÇΩ`;
    }

    function formatDate(value) {
      if (!value) return '‚Äî';
      return new Date(value).toLocaleString('ru-RU', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function formatStatus(value) {
      if (!value) return '‚Äî';
      const statusMap = {
        '–ê–∫—Ç–∏–≤–Ω—ã–π –ø–æ–∏—Å–∫ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞': 'üîç –ê–∫—Ç–∏–≤–Ω—ã–π –ø–æ–∏—Å–∫',
        'string': 'üìù –ß–µ—Ä–Ω–æ–≤–∏–∫',
        '–û—Ç–∫—Ä—ã—Ç–∞': '‚úÖ –û—Ç–∫—Ä—ã—Ç–∞',
        '–ó–∞–∫—Ä—ã—Ç–∞': '‚ùå –ó–∞–∫—Ä—ã—Ç–∞'
      };
      return statusMap[value] || value;
    }

    function formatQuestions(value) {
      if (!Array.isArray(value)) return '‚Äî';
      return value.length > 0 ? `üìã ${value.length}` : '‚Äî';
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ HTMX
    document.body.addEventListener("htmx:responseError", function(evt) {
      document.getElementById("vacancy-list").innerHTML = `
        <div class="p-6 text-red-600">
          –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${evt.detail.xhr.status} ${evt.detail.xhr.statusText}
        </div>
      `;
    });
  </script>

</body>
</html>